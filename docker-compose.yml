# version: "3.8"

services:
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    ports:
      - "3000:3000" # point d'entr√©e public (gateway)
    restart: unless-stopped
    environment:
      - RECIPE_HOST=api-recipe
      - USER_HOST=api-user
    depends_on:
      - api-user
      - api-recipe
    networks:
      - app-network

  api-user:
    build:
      context: ./api-user
      dockerfile: Dockerfile
    expose:
      - "3333"
    restart: unless-stopped
    networks:
      - app-network
    depends_on:
      - user-db

  api-recipe:
    build:
      context: ./api-recipe
      dockerfile: Dockerfile
    expose:
      - "3030"
    restart: unless-stopped
    networks:
      - app-network
    depends_on:
      - recipe-db

  user-db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: user
      POSTGRES_DB: users_db
      PGDATA: /var/lib/postgresql/data
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      app-network:
        aliases:
          - db-user

  recipe-db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: recipe
      POSTGRES_PASSWORD: recipe
      POSTGRES_DB: recipes_db
      PGDATA: /var/lib/postgresql/data
    volumes:
      - recipe-db-data:/var/lib/postgresql/data
    networks:
      app-network:
        aliases:
          - db-recipe

  adminer:
    image: adminer
    container_name: adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    networks:
      - app-network

volumes:
  user-db-data:
  recipe-db-data:

networks:
  app-network:
    driver: bridge
    external: true
